<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Results - ImproveCommunication</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <script src="../js/config.js"></script>
    <style>
        .results-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .results-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .results-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .results-header h1 {
            margin: 0 0 10px 0;
            color: #667eea;
        }
        
        .call-duration {
            color: #666;
            font-size: 18px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .result-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .result-card h2 {
            color: #667eea;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .rating-section {
            margin: 20px 0;
        }
        
        .rating-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .rating-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .rating-stars {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .rating-stars .stars {
            font-size: 24px;
            color: #ffd700;
        }
        
        .rating-score {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .weaknesses-list {
            list-style: none;
            padding: 0;
        }
        
        .weaknesses-list li {
            background: #fff3cd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .feedback-text {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            line-height: 1.6;
            color: #333;
        }
        
        .rate-partner-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .star-rating {
            display: flex;
            gap: 10px;
            font-size: 36px;
            margin: 15px 0;
        }
        
        .star {
            cursor: pointer;
            color: #ddd;
            transition: color 0.2s;
        }
        
        .star.active,
        .star:hover {
            color: #ffd700;
        }
        
        .feedback-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin: 10px 0;
            resize: vertical;
            min-height: 80px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: white;
            font-size: 20px;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .quiz-prompt {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
        }
        
        .quiz-prompt h3 {
            margin-top: 0;
        }
        
        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="results-page">
        <div class="results-container">
            <!-- Loading State -->
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <h2>üìä Analyzing your call...</h2>
                <p>AI is processing your conversation</p>
            </div>
            
            <!-- Results Content -->
            <div id="results-content" style="display: none;">
                <!-- Header -->
                <div class="results-header">
                    <h1>üéâ Call Completed!</h1>
                    <p class="call-duration" id="call-duration">Duration: --:--</p>
                    <p id="partner-name">With: Partner</p>
                </div>
                
                <!-- Results Grid -->
                <div class="results-grid">
                    <!-- Your Results -->
                    <div class="result-card">
                        <h2>üìà Your Performance</h2>
                        
                        <div class="rating-section">
                            <div class="rating-box">
                                <div class="rating-title">ü§ñ AI Rating</div>
                                <div class="rating-stars">
                                    <span class="rating-score" id="my-ai-score">-</span>
                                    <span class="stars" id="my-ai-stars"></span>
                                </div>
                                <div class="feedback-text" id="my-ai-feedback">Analyzing...</div>
                            </div>
                            
                            <div class="rating-box">
                                <div class="rating-title">üë§ Partner Rating</div>
                                <div class="rating-stars">
                                    <span class="rating-score" id="my-peer-score">-</span>
                                    <span class="stars" id="my-peer-stars"></span>
                                </div>
                                <div class="feedback-text" id="my-peer-feedback">Waiting for partner...</div>
                            </div>
                        </div>
                        
                        <h3>üìù Areas to Improve</h3>
                        <ul class="weaknesses-list" id="my-weaknesses">
                            <li>Analyzing...</li>
                        </ul>
                    </div>
                    
                    <!-- Partner Results -->
                    <div class="result-card">
                        <h2>üí¨ Rate Your Partner</h2>
                        
                        <div class="rate-partner-section">
                            <div class="rating-title">How was their English?</div>
                            <div class="star-rating" id="partner-star-rating">
                                <span class="star" data-rating="1">‚≠ê</span>
                                <span class="star" data-rating="2">‚≠ê</span>
                                <span class="star" data-rating="3">‚≠ê</span>
                                <span class="star" data-rating="4">‚≠ê</span>
                                <span class="star" data-rating="5">‚≠ê</span>
                            </div>
                            <p id="rating-selected" style="color: #666; font-style: italic;">Click stars to rate</p>
                            
                            <label style="display: block; margin-top: 15px; font-weight: 600; color: #333;">
                                Feedback (Optional)
                            </label>
                            <textarea 
                                id="partner-feedback" 
                                class="feedback-input" 
                                placeholder="Share your thoughts about this conversation..."
                            ></textarea>
                            
                            <button class="btn btn-primary" onclick="submitRating()" id="submit-rating-btn">
                                Submit Rating
                            </button>
                        </div>
                        
                        <div class="rating-box" style="margin-top: 20px;">
                            <div class="rating-title">Partner's AI Rating</div>
                            <div class="rating-stars">
                                <span class="rating-score" id="partner-ai-score">-</span>
                                <span class="stars" id="partner-ai-stars"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quiz Generation -->
                <div class="quiz-prompt">
                    <h3>üéì Ready to Improve?</h3>
                    <p>Based on your weaknesses, we can generate a personalized quiz to help you practice!</p>
                    <button class="btn btn-success" onclick="generateQuiz()" id="generate-quiz-btn">
                        üìö Generate Quiz
                    </button>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons" style="justify-content: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="window.location.href='users.html'">
                        üîÑ Find Another Partner
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                        üè† Back to Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let callId = null;
        let callData = null;
        let selectedRating = 0;
        let partnerId = null;
        
        // Check authentication
        async function checkAuth() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (!token || !user) {
                window.location.href = 'login.html';
                return null;
            }
            
            return JSON.parse(user);
        }
        
        // Format duration
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // Generate star display
        function generateStars(rating) {
            if (!rating) return '';
            const fullStars = Math.floor(rating);
            const hasHalf = rating % 1 >= 0.5;
            let stars = '‚≠ê'.repeat(fullStars);
            if (hasHalf) stars += '‚ú®';
            return stars;
        }
        
        // Load call results
        async function loadResults() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/calls/${callId}/results`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.status === 202) {
                    // Analysis not ready yet
                    document.getElementById('loading').innerHTML = `
                        <div class="loading-spinner"></div>
                        <h2>‚è≥ Analysis in Progress</h2>
                        <p>Your call audio is being processed by AI</p>
                        <p>This usually takes 2-5 minutes</p>
                        <button class="btn btn-primary" onclick="window.location.href='dashboard.html'" style="margin-top: 20px;">
                            Go to Dashboard
                        </button>
                    `;
                    return;
                }
                
                if (response.status === 400) {
                    // Call too short or no real conversation
                    const error = await response.json();
                    document.getElementById('loading').innerHTML = `
                        <div style="text-align: center; color: white;">
                            <h2>‚ö†Ô∏è Unable to Analyze Call</h2>
                            <p style="font-size: 18px; margin: 20px 0;">${error.detail || 'Call was too short for meaningful analysis'}</p>
                            <p>Please ensure:</p>
                            <ul style="text-align: left; display: inline-block; margin: 20px auto;">
                                <li>Both users join the call</li>
                                <li>You speak for at least 10 seconds</li>
                                <li>Audio is enabled in the call</li>
                            </ul>
                            <div style="margin-top: 30px;">
                                <button class="btn btn-primary" onclick="window.location.href='users.html'" style="margin: 10px;">
                                    Try Another Call
                                </button>
                                <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'" style="margin: 10px;">
                                    Back to Dashboard
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Failed to load results');
                }
                
                callData = await response.json();
                displayResults();
            } catch (error) {
                console.error('Error loading results:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="text-align: center; color: white;">
                        <h2>‚ùå Error Loading Results</h2>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="window.location.href='dashboard.html'" style="margin-top: 20px;">
                            Back to Dashboard
                        </button>
                    </div>
                `;
            }
        }
        
        // Display results
        function displayResults() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results-content').style.display = 'block';
            
            // Duration
            if (callData.duration_seconds) {
                document.getElementById('call-duration').textContent = 
                    `Duration: ${formatDuration(callData.duration_seconds)}`;
            }
            
            // Determine if current user is caller or receiver
            const isCaller = callData.caller_id === currentUser.id;
            const myRatings = isCaller ? {
                ai: callData.caller_ai_rating,
                peer: callData.caller_peer_rating,
                ai_feedback: callData.caller_ai_feedback,
                peer_feedback: callData.caller_peer_feedback,
                weaknesses: callData.caller_weaknesses
            } : {
                ai: callData.receiver_ai_rating,
                peer: callData.receiver_peer_rating,
                ai_feedback: callData.receiver_ai_feedback,
                peer_feedback: callData.receiver_peer_feedback,
                weaknesses: callData.receiver_weaknesses
            };
            
            const partnerRatings = isCaller ? {
                ai: callData.receiver_ai_rating
            } : {
                ai: callData.caller_ai_rating
            };
            
            partnerId = isCaller ? callData.receiver_id : callData.caller_id;
            
            // My AI Rating
            if (myRatings.ai) {
                document.getElementById('my-ai-score').textContent = myRatings.ai.toFixed(1);
                document.getElementById('my-ai-stars').textContent = generateStars(myRatings.ai);
                document.getElementById('my-ai-feedback').textContent = 
                    myRatings.ai_feedback || 'Great conversation!';
            }
            
            // My Peer Rating
            if (myRatings.peer) {
                document.getElementById('my-peer-score').textContent = myRatings.peer.toFixed(1);
                document.getElementById('my-peer-stars').textContent = generateStars(myRatings.peer);
                if (myRatings.peer_feedback) {
                    document.getElementById('my-peer-feedback').textContent = myRatings.peer_feedback;
                }
            } else {
                document.getElementById('my-peer-feedback').textContent = 
                    'Waiting for your partner to rate you...';
            }
            
            // My Weaknesses
            if (myRatings.weaknesses && myRatings.weaknesses.length > 0) {
                const list = document.getElementById('my-weaknesses');
                list.innerHTML = '';
                myRatings.weaknesses.forEach(weakness => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>‚ö†Ô∏è</span> ${weakness}`;
                    list.appendChild(li);
                });
            }
            
            // Partner AI Rating
            if (partnerRatings.ai) {
                document.getElementById('partner-ai-score').textContent = partnerRatings.ai.toFixed(1);
                document.getElementById('partner-ai-stars').textContent = generateStars(partnerRatings.ai);
            }
        }
        
        // Star rating interaction
        document.addEventListener('DOMContentLoaded', () => {
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateStarDisplay();
                });
                
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    stars.forEach((s, idx) => {
                        if (idx < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
            
            document.getElementById('partner-star-rating').addEventListener('mouseleave', () => {
                updateStarDisplay();
            });
        });
        
        function updateStarDisplay() {
            const stars = document.querySelectorAll('.star');
            stars.forEach((s, idx) => {
                if (idx < selectedRating) {
                    s.classList.add('active');
                } else {
                    s.classList.remove('active');
                }
            });
            
            if (selectedRating > 0) {
                document.getElementById('rating-selected').textContent = 
                    `You selected ${selectedRating} star${selectedRating > 1 ? 's' : ''}`;
            }
        }
        
        // Submit rating
        async function submitRating() {
            if (selectedRating === 0) {
                alert('Please select a rating');
                return;
            }
            
            const feedback = document.getElementById('partner-feedback').value.trim();
            const token = localStorage.getItem('token');
            const btn = document.getElementById('submit-rating-btn');
            
            btn.disabled = true;
            btn.textContent = 'Submitting...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/calls/rate-partner`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        call_id: callId,
                        rating: selectedRating,
                        feedback: feedback || null
                    })
                });
                
                if (response.ok) {
                    btn.textContent = '‚úì Rating Submitted';
                    btn.style.background = '#28a745';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = 'Update Rating';
                        btn.style.background = '';
                    }, 2000);
                } else {
                    throw new Error('Failed to submit rating');
                }
            } catch (error) {
                console.error('Error submitting rating:', error);
                alert('Failed to submit rating. Please try again.');
                btn.disabled = false;
                btn.textContent = 'Submit Rating';
            }
        }
        
        // Generate quiz
        async function generateQuiz() {
            const token = localStorage.getItem('token');
            const btn = document.getElementById('generate-quiz-btn');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating quiz...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/calls/${callId}/generate-quiz`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const quiz = await response.json();
                    // Redirect to quiz page
                    window.location.href = `quiz.html?quizId=${quiz.id}`;
                } else {
                    throw new Error('Failed to generate quiz');
                }
            } catch (error) {
                console.error('Error generating quiz:', error);
                alert('Failed to generate quiz. Please try again.');
                btn.disabled = false;
                btn.textContent = 'üìö Generate Quiz';
            }
        }
        
        // Initialize
        window.onload = async function() {
            currentUser = await checkAuth();
            
            if (currentUser) {
                const urlParams = new URLSearchParams(window.location.search);
                callId = urlParams.get('callId');
                
                if (!callId) {
                    alert('No call ID provided');
                    window.location.href = 'dashboard.html';
                    return;
                }
                
                // Simulate processing time
                setTimeout(() => {
                    loadResults();
                }, 2000);
            }
        };
    </script>
</body>
</html>
